name: Docker Image Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'version of this branch'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log into GitHub Container Registry
      run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build and push Docker image
      run: |
        PLATFORMS=linux/arm64,linux/amd64
        DOCKER_IMAGE=ghcr.io/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        ARCH_TAGS="arm64 amd64"
        VERSION=${{ inputs.version || github.sha }}
        echo "DOCKER_IMAGE_LOWERCASE=$DOCKER_IMAGE" >> $GITHUB_ENV
        echo "IMAGE_VERSION=$VERSION" >> $GITHUB_ENV
        docker buildx build --platform $PLATFORMS \
          -f Dockerfile.github-actions \
          -t $DOCKER_IMAGE:latest \
          -t $DOCKER_IMAGE:${VERSION} \
          --push .
        for ARCH in $ARCH_TAGS; do
          if [ "$ARCH" == "arm64" ]; then
            TAG_ARCH="aarch64"
          else
            TAG_ARCH=$ARCH
          fi
          docker buildx build --platform linux/${ARCH} \
            -f Dockerfile.github-actions \
            -t ${DOCKER_IMAGE}-${TAG_ARCH}:latest \
            -t ${DOCKER_IMAGE}-${TAG_ARCH}:${VERSION} \
            --push .
        done

    - name: Run security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_IMAGE_LOWERCASE }}:${{ env.IMAGE_VERSION }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif' 